<!DOCTYPE html>
<html lang="zh-CN">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>zyc â¤ï¸ yjy</title>
<link rel="icon" href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><text y='.9em' font-size='90'>ğŸ’—</text></svg>">
<link href="https://fonts.googleapis.com/css2?family=Ma+Shan+Zheng&family=ZCOOL+XiaoWei&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
<style>
*, *::before, *::after { margin: 0; padding: 0; box-sizing: border-box; }

:root {
  --rose: #e8456b;
  --rose-light: #fce4ec;
  --rose-deep: #c62828;
  --gold: #d4a056;
  --cream: #fdf6f0;
  --ink: #2d1b14;
  --blush: #f8e8e0;
}

html { scroll-behavior: smooth; }

body {
  font-family: 'Noto Serif SC', serif;
  background: var(--cream);
  color: var(--ink);
  overflow-x: hidden;
  min-height: 100vh;
  padding-bottom: 0; /* åŠ¨æ€æ§åˆ¶ï¼šå¯¼èˆªæ å‡ºç°åæ‰åŠ padding */
}

/* ============ LOADING OVERLAY (ç­‰å¾…FirebaseåŠ è½½) ============ */
.loading-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: var(--cream);
  z-index: 9999;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 1rem;
  transition: opacity 0.5s ease;
}

.loading-overlay.hidden {
  opacity: 0;
  pointer-events: none;
}

.loading-heart {
  font-size: 3rem;
  animation: heartPulse 1s ease infinite;
}

.loading-text {
  font-family: 'Ma Shan Zheng', cursive;
  font-size: 1.2rem;
  color: var(--rose);
}

/* ============ FLOATING PARTICLES ============ */
.particles {
  position: fixed;
  top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none;
  z-index: 0;
  overflow: hidden;
}

.particle {
  position: absolute;
  font-size: 1.2rem;
  opacity: 0;
  animation: floatUp 8s ease-in infinite;
}

@keyframes floatUp {
  0% { opacity: 0; transform: translateY(100vh) rotate(0deg); }
  10% { opacity: 0.7; }
  90% { opacity: 0.7; }
  100% { opacity: 0; transform: translateY(-10vh) rotate(360deg); }
}

/* ============ BOTTOM NAV ============ */
.bottom-nav {
  position: fixed;
  bottom: 0;
  left: 0;
  right: 0;
  height: 64px;
  background: rgba(255, 255, 255, 0.92);
  backdrop-filter: blur(12px);
  -webkit-backdrop-filter: blur(12px);
  border-top: 1px solid rgba(232, 69, 107, 0.1);
  display: none; /* è¡¨ç™½å®Œæˆå‰éšè— */
  justify-content: space-around;
  align-items: center;
  z-index: 100;
  box-shadow: 0 -2px 20px rgba(0,0,0,0.04);
}

.bottom-nav.visible { display: flex; }

.nav-item {
  display: flex;
  flex-direction: column;
  align-items: center;
  gap: 3px;
  cursor: pointer;
  padding: 6px 16px;
  border-radius: 12px;
  transition: all 0.25s;
  -webkit-tap-highlight-color: transparent;
  user-select: none;
}

.nav-item:hover { background: var(--rose-light); }
.nav-item.active .nav-icon { transform: scale(1.15); }
.nav-item.active .nav-label { color: var(--rose); font-weight: 700; }

.nav-icon {
  font-size: 1.4rem;
  transition: transform 0.25s;
  line-height: 1;
}

.nav-label {
  font-size: 0.7rem;
  color: #999;
  font-family: 'ZCOOL XiaoWei', serif;
  transition: color 0.25s;
}

/* ============ PAGES ============ */
.page {
  display: none;
  min-height: 100vh;
  position: relative;
  z-index: 1;
}
.page.active { display: block; }

/* ============ PAGE: LETTER ============ */
#page-letter {
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  padding: 3rem 1.5rem;
  min-height: 100vh;
  background: linear-gradient(175deg, #fdf6f0 0%, #fce4ec 40%, #f8e8e0 100%);
}

.envelope-wrapper {
  animation: envelopeDrop 1.2s cubic-bezier(0.34, 1.56, 0.64, 1) both;
  margin-bottom: 2rem;
}

@keyframes envelopeDrop {
  0% { opacity: 0; transform: translateY(-60px) scale(0.8); }
  100% { opacity: 1; transform: translateY(0) scale(1); }
}

.envelope-icon {
  font-size: 4rem;
  cursor: pointer;
  transition: transform 0.3s;
  text-align: center;
}
.envelope-icon:hover { transform: scale(1.15) rotate(-5deg); }

.letter-container {
  max-width: 680px;
  width: 100%;
  background: white;
  border-radius: 16px;
  padding: 3rem 2.5rem;
  box-shadow: 0 20px 60px rgba(200, 100, 100, 0.15), 0 1px 3px rgba(0,0,0,0.05);
  position: relative;
  overflow: hidden;
  animation: letterReveal 1s 0.5s ease both;
}

@keyframes letterReveal {
  0% { opacity: 0; transform: translateY(30px); }
  100% { opacity: 1; transform: translateY(0); }
}

.letter-container::before {
  content: '';
  position: absolute;
  top: 0; left: 0; right: 0;
  height: 5px;
  background: linear-gradient(90deg, var(--rose), var(--gold), var(--rose));
}

.letter-date {
  text-align: right;
  font-size: 0.85rem;
  color: #999;
  margin-bottom: 1.5rem;
  font-style: italic;
}

.letter-greeting {
  font-family: 'Ma Shan Zheng', cursive;
  font-size: 1.8rem;
  color: var(--rose);
  margin-bottom: 1.5rem;
}

.letter-body {
  line-height: 2.2;
  font-size: 1.05rem;
  color: #3a2a22;
  text-align: justify;
}

.letter-body p {
  margin-bottom: 1.2rem;
  text-indent: 2em;
}

/* åªåœ¨é¦–æ¬¡åŠ è½½æ—¶æ’­æ”¾é€è¡ŒåŠ¨ç”» */
.letter-body.animate p {
  animation: fadeInLine 0.8s ease both;
}
.letter-body.animate p:nth-child(1) { animation-delay: 0.8s; }
.letter-body.animate p:nth-child(2) { animation-delay: 1.2s; }
.letter-body.animate p:nth-child(3) { animation-delay: 1.6s; }
.letter-body.animate p:nth-child(4) { animation-delay: 2.0s; }
.letter-body.animate p:nth-child(5) { animation-delay: 2.4s; }
.letter-body.animate p:nth-child(6) { animation-delay: 2.8s; }
.letter-body.animate p:nth-child(7) { animation-delay: 3.2s; }

@keyframes fadeInLine {
  0% { opacity: 0; transform: translateX(-10px); }
  100% { opacity: 1; transform: translateX(0); }
}

.letter-sign {
  text-align: right;
  font-family: 'Ma Shan Zheng', cursive;
  font-size: 1.4rem;
  color: var(--rose-deep);
  margin-top: 2rem;
}

/* é¦–æ¬¡è¿›å…¥æ—¶çš„ç»§ç»­æç¤ºï¼ˆè¡¨ç™½å‰ï¼‰ */
.scroll-hint {
  margin-top: 2.5rem;
  animation: bounce 2s ease infinite;
  font-size: 0.9rem;
  color: var(--rose);
  cursor: pointer;
  text-align: center;
}

@keyframes bounce {
  0%, 20%, 50%, 80%, 100% { transform: translateY(0); }
  40% { transform: translateY(-10px); }
  60% { transform: translateY(-5px); }
}

/* ============ PAGE: QUESTION ============ */
#page-question {
  display: none;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 100vh;
  height: 100vh;
  padding: 2rem;
  background: radial-gradient(ellipse at center, #fff5f5, #fce4ec, #f8d7e0);
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  z-index: 50;
}

.question-title {
  font-family: 'Ma Shan Zheng', cursive;
  font-size: clamp(2rem, 5vw, 3.5rem);
  color: var(--rose-deep);
  text-align: center;
  margin-bottom: 3rem;
  animation: heartbeat 1.5s ease infinite;
  text-shadow: 0 2px 10px rgba(200, 40, 40, 0.15);
}

@keyframes heartbeat {
  0%, 100% { transform: scale(1); }
  14% { transform: scale(1.05); }
  28% { transform: scale(1); }
  42% { transform: scale(1.05); }
}

.buttons-wrapper {
  display: flex;
  gap: 2.5rem;
  justify-content: center;
  align-items: center;
  width: 100%;
  max-width: 500px;
}

.btn-love {
  padding: 1rem 3rem;
  font-size: 1.3rem;
  font-family: 'ZCOOL XiaoWei', serif;
  border: none;
  border-radius: 50px;
  cursor: pointer;
  transition: all 0.3s;
  z-index: 2;
}

.btn-yes {
  background: linear-gradient(135deg, var(--rose), #ff6b8a);
  color: white;
  box-shadow: 0 8px 25px rgba(232, 69, 107, 0.4);
}
.btn-yes:hover {
  transform: scale(1.1);
  box-shadow: 0 12px 35px rgba(232, 69, 107, 0.5);
}

.btn-no {
  background: #f5f5f5;
  color: #999;
  box-shadow: 0 4px 15px rgba(0,0,0,0.08);
  transition: all 0.15s ease;
}

/* ============ PAGE: TOGETHER (çˆ±å¿ƒè®¡æ—¶) ============ */
#page-together {
  display: none;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
  background: linear-gradient(180deg, #fdf6f0 0%, #fff 50%, #fce4ec 100%);
  padding-top: 2rem;
}

.together-header {
  width: 100%;
  padding: 2rem;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  min-height: 80vh;
}

.big-heart {
  width: 220px;
  height: 220px;
  position: relative;
  animation: heartPulse 2s ease infinite;
  margin-bottom: 1.5rem;
}

@keyframes heartPulse {
  0%, 100% { transform: scale(1); }
  50% { transform: scale(1.05); }
}

.big-heart svg {
  width: 100%;
  height: 100%;
  filter: drop-shadow(0 10px 30px rgba(232, 69, 107, 0.3));
}

.timer-display { text-align: center; }

.timer-label {
  font-family: 'Ma Shan Zheng', cursive;
  font-size: 1.6rem;
  color: var(--rose);
  margin-bottom: 0.8rem;
}

.timer-value {
  font-family: 'ZCOOL XiaoWei', serif;
  font-size: clamp(1.2rem, 3vw, 1.8rem);
  color: var(--ink);
  letter-spacing: 2px;
}

.timer-value span {
  display: inline-block;
  background: white;
  padding: 0.3rem 0.6rem;
  border-radius: 8px;
  margin: 0 2px;
  box-shadow: 0 2px 8px rgba(0,0,0,0.06);
  min-width: 45px;
  text-align: center;
}

.timer-value .timer-unit {
  font-size: 0.7rem;
  color: #999;
  display: block;
  margin-top: 2px;
}

/* ============ PAGE: DIARY (æ—¥è®°æœ¬) ============ */
#page-diary {
  display: none;
  flex-direction: column;
  align-items: center;
  min-height: 100vh;
  background: linear-gradient(180deg, #fdf6f0 0%, #fff 100%);
  padding-top: 2rem;
}

/* ---- DIARY LOCK OVERLAY ---- */
.diary-lock-overlay {
  position: fixed;
  top: 0; left: 0; right: 0; bottom: 0;
  background: linear-gradient(180deg, #fdf6f0 0%, #fce4ec 100%);
  z-index: 200;
  display: flex;
  flex-direction: column;
  align-items: center;
  justify-content: center;
  gap: 1.5rem;
  opacity: 1;
  transition: opacity 0.5s ease, transform 0.5s ease;
}

.diary-lock-overlay.unlocked {
  opacity: 0;
  transform: scale(1.05);
  pointer-events: none;
}

.lock-icon {
  font-size: 4rem;
  animation: lockBounce 2s ease infinite;
}

@keyframes lockBounce {
  0%, 100% { transform: translateY(0); }
  50% { transform: translateY(-8px); }
}

.lock-title {
  font-family: 'Ma Shan Zheng', cursive;
  font-size: 1.8rem;
  color: var(--rose);
}

.lock-subtitle {
  font-size: 0.9rem;
  color: #aaa;
  margin-top: -0.5rem;
}

.lock-input-wrapper {
  display: flex;
  gap: 0.8rem;
  align-items: center;
}

.lock-input {
  width: 200px;
  padding: 0.8rem 1.2rem;
  border: 2px solid var(--blush);
  border-radius: 50px;
  font-family: 'Noto Serif SC', serif;
  font-size: 1.1rem;
  text-align: center;
  letter-spacing: 4px;
  outline: none;
  transition: border-color 0.3s;
  color: var(--ink);
  background: white;
}

.lock-input:focus {
  border-color: var(--rose);
}

.lock-input::placeholder {
  letter-spacing: 1px;
  color: #ccc;
}

.lock-btn {
  padding: 0.8rem 1.8rem;
  background: linear-gradient(135deg, var(--rose), #ff6b8a);
  color: white;
  border: none;
  border-radius: 50px;
  font-family: 'ZCOOL XiaoWei', serif;
  font-size: 1rem;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 15px rgba(232, 69, 107, 0.3);
}

.lock-btn:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(232, 69, 107, 0.4);
}

.lock-error {
  font-size: 0.85rem;
  color: var(--rose-deep);
  height: 1.2rem;
  transition: opacity 0.3s;
}

.lock-error.hidden { opacity: 0; }

@keyframes shake {
  0%, 100% { transform: translateX(0); }
  20%, 60% { transform: translateX(-8px); }
  40%, 80% { transform: translateX(8px); }
}

.shake { animation: shake 0.4s ease; }

/* ---- END DIARY LOCK ---- */

.diary-section {
  width: 100%;
  max-width: 700px;
  padding: 2rem;
}

.section-title {
  font-family: 'Ma Shan Zheng', cursive;
  font-size: 2rem;
  color: var(--rose);
  text-align: center;
  margin-bottom: 2rem;
}

.section-title::after {
  content: '';
  display: block;
  width: 60px;
  height: 2px;
  background: var(--gold);
  margin: 0.5rem auto 0;
}

.diary-form {
  background: white;
  border-radius: 16px;
  padding: 2rem;
  box-shadow: 0 8px 30px rgba(0,0,0,0.06);
  margin-bottom: 2rem;
}

.diary-form textarea {
  width: 100%;
  min-height: 120px;
  border: 2px solid var(--blush);
  border-radius: 12px;
  padding: 1rem;
  font-family: 'Noto Serif SC', serif;
  font-size: 1rem;
  color: var(--ink);
  resize: vertical;
  transition: border-color 0.3s;
  outline: none;
  line-height: 1.8;
}

.diary-form textarea:focus { border-color: var(--rose); }
.diary-form textarea::placeholder { color: #ccc; }

.photo-upload-area {
  margin-top: 1rem;
  border: 2px dashed var(--blush);
  border-radius: 12px;
  padding: 1.5rem;
  text-align: center;
  cursor: pointer;
  transition: all 0.3s;
  position: relative;
  overflow: hidden;
}

.photo-upload-area:hover {
  border-color: var(--rose);
  background: var(--rose-light);
}

.photo-upload-area input {
  position: absolute;
  top: 0; left: 0;
  width: 100%; height: 100%;
  opacity: 0;
  cursor: pointer;
}

.photo-upload-text { color: #aaa; font-size: 0.95rem; }
.photo-upload-text .icon { font-size: 2rem; display: block; margin-bottom: 0.5rem; }

.photo-preview { display: flex; flex-wrap: wrap; gap: 0.5rem; margin-top: 1rem; }
.photo-preview img { width: 80px; height: 80px; object-fit: cover; border-radius: 8px; }

.btn-submit-diary {
  margin-top: 1.2rem;
  width: 100%;
  padding: 0.9rem;
  background: linear-gradient(135deg, var(--rose), #ff6b8a);
  color: white;
  border: none;
  border-radius: 50px;
  font-family: 'ZCOOL XiaoWei', serif;
  font-size: 1.1rem;
  cursor: pointer;
  transition: all 0.3s;
  box-shadow: 0 4px 15px rgba(232, 69, 107, 0.3);
}

.btn-submit-diary:hover {
  transform: translateY(-2px);
  box-shadow: 0 8px 25px rgba(232, 69, 107, 0.4);
}

.btn-submit-diary:disabled {
  opacity: 0.6;
  cursor: not-allowed;
  transform: none;
}

.diary-entries {
  display: flex;
  flex-direction: column;
  gap: 1.5rem;
  padding-bottom: 1rem;
}

.diary-entry {
  background: white;
  border-radius: 16px;
  padding: 1.5rem 2rem;
  box-shadow: 0 4px 20px rgba(0,0,0,0.05);
  animation: slideUp 0.5s ease both;
  position: relative;
}

@keyframes slideUp {
  0% { opacity: 0; transform: translateY(20px); }
  100% { opacity: 1; transform: translateY(0); }
}

.entry-date { font-size: 0.8rem; color: var(--gold); margin-bottom: 0.8rem; font-style: italic; }
.entry-text { line-height: 1.8; color: var(--ink); margin-bottom: 1rem; white-space: pre-wrap; }
.entry-photos { display: flex; flex-wrap: wrap; gap: 0.5rem; }

.entry-photos img {
  width: 120px; height: 120px;
  object-fit: cover;
  border-radius: 10px;
  cursor: pointer;
  transition: transform 0.3s;
}
.entry-photos img:hover { transform: scale(1.05); }

.entry-delete {
  position: absolute; top: 1rem; right: 1rem;
  background: none; border: none; color: #ddd;
  cursor: pointer; font-size: 1.2rem; transition: color 0.3s;
}
.entry-delete:hover { color: var(--rose); }

/* Lightbox */
.lightbox {
  display: none; position: fixed;
  top: 0; left: 0; width: 100%; height: 100%;
  background: rgba(0,0,0,0.9);
  z-index: 1000;
  align-items: center; justify-content: center;
  cursor: zoom-out;
}
.lightbox.active { display: flex; }
.lightbox img { max-width: 90%; max-height: 90%; border-radius: 8px; object-fit: contain; }

/* Confetti */
.confetti-container {
  position: fixed; top: 0; left: 0;
  width: 100%; height: 100%;
  pointer-events: none; z-index: 999;
}

.confetti-piece {
  position: absolute; top: -10px;
  animation: confettiFall 3s ease-in forwards;
}

@keyframes confettiFall {
  0% { opacity: 1; transform: translateY(0) rotate(0deg); }
  100% { opacity: 0; transform: translateY(100vh) rotate(720deg); }
}

/* Reset */
.reset-link {
  display: inline-block;
  margin-top: 1.5rem;
  margin-bottom: 1rem;
  font-size: 0.75rem;
  color: #ccc;
  cursor: pointer;
  text-align: center;
  width: 100%;
}
.reset-link:hover { color: #aaa; }

@media (max-width: 600px) {
  .letter-container { padding: 2rem 1.5rem; }
  .btn-love { padding: 0.8rem 2rem; font-size: 1.1rem; }
  .big-heart { width: 160px; height: 160px; }
  .diary-form { padding: 1.5rem; }
}
</style>
</head>
<body>

<!-- ============ åŠ è½½é®ç½©ï¼ˆç­‰å¾…Firebaseæ•°æ®ï¼‰ ============ -->
<div class="loading-overlay" id="loading-overlay">
  <div class="loading-heart">ğŸ’—</div>
  <div class="loading-text">åŠ è½½ä¸­...</div>
</div>

<div class="particles" id="particles"></div>
<div class="lightbox" id="lightbox" onclick="this.classList.remove('active')"><img id="lightbox-img" src="" alt=""></div>
<div class="confetti-container" id="confetti"></div>

<!-- ============ BOTTOM NAVIGATION BAR ============ -->
<nav class="bottom-nav" id="bottom-nav">
  <div class="nav-item active" onclick="switchPage('letter')" id="nav-letter">
    <span class="nav-icon">ğŸ’Œ</span>
    <span class="nav-label">æƒ…ä¹¦</span>
  </div>
  <div class="nav-item" onclick="switchPage('together')" id="nav-together">
    <span class="nav-icon">ğŸ’—</span>
    <span class="nav-label">åœ¨ä¸€èµ·</span>
  </div>
  <div class="nav-item" onclick="switchPage('diary')" id="nav-diary">
    <span class="nav-icon">ğŸ“–</span>
    <span class="nav-label">æ—¥è®°æœ¬</span>
  </div>
</nav>

<!-- ============ PAGE: LOVE LETTER ============ -->
<div class="page active" id="page-letter">
  <div class="envelope-wrapper">
    <div class="envelope-icon">ğŸ’Œ</div>
  </div>
  <div class="letter-container">
    <div class="letter-date">2026å¹´äº‘å—æ³¸æ²½æ¹–ä¹‹æ—…</div>
    <div class="letter-greeting">äº²çˆ±çš„å°å°¹æ®¿ä¸‹ï¼š</div>
    <div class="letter-body animate" id="letter-body">
      <p>è‡³ä»Šæƒ³èµ·æˆ‘ä»¬çš„åˆé‡ï¼Œä¾ç„¶ä¼šæ„Ÿå¹å‘½è¿çš„å¥‡å¦™ï¼ä¸€è¶Ÿæ™®æ™®é€šé€šçš„å½’é€”åˆ—è½¦ï¼Œå´è®©ä¸¤ä¸ªåŸæœ¬æ¯«æ— äº¤é›†çš„çµé­‚ï¼Œåƒè¢«æœˆè€å·å·ç‰µäº†çº¢çº¿ä¸€èˆ¬ï¼Œæ¯«æ— é¢„å…†åœ°æ’è¿›äº†å½¼æ­¤çš„ç”Ÿå‘½é‡Œã€‚æœ‰æ—¶å€™æˆ‘ç”šè‡³ä¼šæ€€ç–‘ï¼Œæ˜¯ä¸æ˜¯è¿™ä¸–é—´çœŸæœ‰å†™å¥½çš„å‰§æœ¬ï¼Œä¸€åˆ‡æ‰å‘ç”Ÿå¾—è¿™æ ·æ°åˆ°å¥½å¤„ä¸è‡ªç„¶ã€‚ä»é‚£ä¸€åˆ»èµ·ï¼Œæˆ‘çš„ä¸–ç•Œé‡Œå°±å¤šäº†ä¸€ä»½ç‹¬å±äºä½ çš„æ¸©æŸ”ä¸çƒ­é—¹ã€‚</p>
      <p>è®¤è¯†ä½ è¶Šä¹…ï¼Œå°±è¶Šå‘è§‰å¾—ä½ åƒä¸€åº§æŒ–æ˜ä¸å®Œçš„å®è—ï¼æˆ‘ä»¬æ€»æ˜¯é‚£ä¹ˆåŒé¢‘ï¼Œä¸€æ ·å¤©é©¬è¡Œç©ºï¼Œä¸€æ ·æŠ½è±¡æœ‰è¶£ï¼Œå¹¶ä¸”æ€»èƒ½å¿«é€Ÿgetåˆ°å¯¹æ–¹çš„ç‚¹ã€‚ä½ æ€»æƒ³ç€xxxï¼Œè€Œæˆ‘è€æ˜¯å¹»æƒ³æˆä¸ºæ­Œæ‰‹ï¼Œè¿™äº›ç™½æ—¥æ¢¦åè€Œç»™æˆ‘ä»¬çš„ç”Ÿæ´»å¢æ·»äº†ä¸å°‘ä¹è¶£ã€‚ä½ ä¹Ÿæ˜¯ä¸ªéå¸¸å¯çˆ±çš„å¥³å­©ï¼Œå°¤å…¶æ˜¯åˆšç¡é†’æ—¶é‚£ç§è½¯è½¯ç³¯ç³¯çš„æ¨¡æ ·ï¼Œåˆ†åˆ†é’Ÿè¦å°†æˆ‘å¿ƒèåŒ–ã€‚å°¹å¸ˆå‚…éª¨å­é‡Œä¸æœè¾“çš„å¥½èƒœå¿ƒä¹Ÿè®©æˆ‘éå¸¸æ¬£èµï¼Œå› ä¸ºæˆ‘æ°æ°ä¹Ÿæ˜¯ç±»ä¼¼çš„äººï¼ŒåŒæ—¶ä¹Ÿæ·±åˆ»åœ°è®¤è¯†åˆ°å°¹å¸ˆå‚…è¿™ä¸€è·¯èµ°æ¥çš„ä¸å®¹æ˜“ï¼Œè¿™å…¨æ˜¯å°¹å¸ˆå‚…åŠªåŠ›å¥‹æ–—çš„æˆæœï¼</p>
      <p>ä½ å¯¹å¾…çˆ±äººæ€»æ˜¯æ¯«æ— ä¿ç•™ï¼ŒæŠŠæ‰€æœ‰çš„ä½“è´´å’Œåœ¨æ„éƒ½æ‰ç¢äº†è—åœ¨ç»†èŠ‚é‡Œï¼Œé‚£äº›æ— å¾®ä¸è‡³çš„ç…§é¡¾ï¼Œæ€»æ˜¯è®©æˆ‘éå¸¸æ„ŸåŠ¨ã€‚å¯æˆ‘ä¹ŸçŸ¥é“ï¼Œæˆ‘çš„å°å°¹æ®¿ä¸‹å¶å°”ä¹Ÿä¼šè„†å¼±ï¼Œä¼šåœ¨æ²¡äººçš„è§’è½å·å·è—èµ·å°æƒ…ç»ªï¼Œä¼šä¸€ä¸ªäººé»˜é»˜å†…è€—ã€‚æ­£æ˜¯è¿™äº›å‘ç€å…‰ã€åˆå¸¦ç€ç‚¹æ•æ„Ÿçš„ç¢ç‰‡ï¼Œæ‹¼å‡‘å‡ºäº†ä¸€ä¸ªå®Œæ•´åˆçœŸå®çš„ä½ ï¼Œä¹Ÿè®©æˆ‘è¶Šæ¥è¶Šæƒ³è¦æ·±å…¥äº†è§£ä½ çš„å…¨éƒ¨ã€‚</p>
      <p>å’Œä½ ç›¸å¤„çš„æ¯ä¸€åˆ»ï¼Œæˆ‘éƒ½åƒè¢«ç£é“å¸å¼•ä¸€èˆ¬ï¼Œä¸æ–­å‘ä½ é æ‹¢ã€‚ä»æœ€åˆè§‰å¾—ä½ æœ‰è¶£ï¼Œåˆ°æ…¢æ…¢è¢«ä½ çš„çœŸè¯šæ‰“åŠ¨ï¼Œå†åˆ°åæ¥å¼€å§‹å¿ƒç–¼ä½ çš„æ•æ„Ÿï¼Œè´ªæ‹ä½ çš„æ¸©æš–ã€‚ä½ åƒå±±åŸçš„é£ï¼Œè½»è½»è£¹ä½æˆ‘æ‰€æœ‰çš„ä¸å®‰ã€‚æˆ‘å˜å¾—è¶Šæ¥è¶Šä¾æ‹ä½ ï¼Œä¾æ‹ä½ çš„é™ªä¼´ï¼Œä¾æ‹ä½ æ€€é‡Œçš„æ¸©åº¦ï¼Œä¾æ‹æ¯ä¸€ä¸ªæœ‰ä½ åœ¨çš„"å¹³å’Œçš„å¹¸ç¦"ç¬é—´ã€‚</p>
      <p>åŒæ—¶ï¼Œæˆ‘ä¹Ÿæƒ³æˆä¸ºä½ çš„é¿é£æ¸¯ï¼Œæ›¿ä½ é®é£æŒ¡é›¨ï¼Œä¸ºä½ æ’å¿§è§£éš¾ã€‚</p>
      <p>æ‰€ä»¥ä»Šå¤©ï¼Œè¶ç€æ³¸æ²½æ¹–çš„é£è¿˜æ¸©æŸ”ï¼Œæˆ‘æƒ³è®¤è®¤çœŸçœŸåœ°é—®ä½ ä¸€ä¸ªé—®é¢˜â€”â€”</p>
      <p>è¯·ä½ ç¿»åˆ°ä¸‹ä¸€é¡µå§ â™¡</p>
    </div>
    <div class="letter-sign">ä½ å¿ å®çš„é›ªçº³ç‘</div>
  </div>
  <!-- è¡¨ç™½å‰æ˜¾ç¤ºçš„"ç»§ç»­"æŒ‰é’® -->
  <div class="scroll-hint" id="scroll-hint" onclick="goToQuestion()">â†“ ç‚¹å‡»ç»§ç»­ â†“</div>
</div>

<!-- ============ PAGE: QUESTION (è¡¨ç™½ï¼Œä¸€æ¬¡æ€§) ============ -->
<div class="page" id="page-question">
  <div class="question-title">ä½³ä»ªï¼Œä½ æ„¿æ„åšæˆ‘çš„å¥³æœ‹å‹å—ï¼Ÿ ğŸ’—</div>
  <div class="buttons-wrapper" id="buttons-wrapper">
    <button class="btn-love btn-yes" onclick="sayYes()">æ„¿æ„ ğŸ’•</button>
    <button class="btn-love btn-no" id="btn-no" onmouseover="runAway()" onclick="runAway()">ä¸æ„¿æ„</button>
  </div>
</div>

<!-- ============ PAGE: TOGETHER (çˆ±å¿ƒè®¡æ—¶) ============ -->
<div class="page" id="page-together">
  <div class="together-header">
    <div class="big-heart">
      <svg viewBox="0 0 200 200" xmlns="http://www.w3.org/2000/svg">
        <defs>
          <linearGradient id="heartGrad" x1="0%" y1="0%" x2="100%" y2="100%">
            <stop offset="0%" style="stop-color:#ff6b8a"/>
            <stop offset="100%" style="stop-color:#e8456b"/>
          </linearGradient>
        </defs>
        <path d="M100 180 C55 140, 10 110, 10 70 C10 35, 40 15, 70 15 C85 15, 95 25, 100 35 C105 25, 115 15, 130 15 C160 15, 190 35, 190 70 C190 110, 145 140, 100 180Z" fill="url(#heartGrad)"/>
        <text x="100" y="95" text-anchor="middle" fill="white" font-family="Ma Shan Zheng, cursive" font-size="20">æˆ‘ä»¬åœ¨ä¸€èµ·</text>
        <text x="100" y="118" text-anchor="middle" fill="rgba(255,255,255,0.8)" font-family="ZCOOL XiaoWei, serif" font-size="11" id="heart-days">0 å¤©</text>
      </svg>
    </div>
    <div class="timer-display">
      <div class="timer-label">åœ¨ä¸€èµ·çš„æ¯ä¸€ç§’éƒ½æ˜¯å¿ƒåŠ¨ â™¡</div>
      <div class="timer-value" id="timer-value">
        <span>0<small class="timer-unit">å¤©</small></span>
        <span>00<small class="timer-unit">æ—¶</small></span>
        <span>00<small class="timer-unit">åˆ†</small></span>
        <span>00<small class="timer-unit">ç§’</small></span>
      </div>
    </div>
  </div>
</div>

<!-- ============ PAGE: DIARY (æ—¥è®°æœ¬) ============ -->
<div class="page" id="page-diary">
  <!-- å¯†ç é”é®ç½© -->
  <div class="diary-lock-overlay" id="diary-lock">
    <div class="lock-icon">ğŸ”’</div>
    <div class="lock-title">è¿™æ˜¯åªå±äºæˆ‘ä»¬çš„ç§˜å¯† â™¡</div>
    <div class="lock-subtitle">è¾“å…¥å¯†ç è§£é”æ—¥è®°æœ¬</div>
    <div class="lock-input-wrapper">
      <input type="password" class="lock-input" id="lock-password" placeholder="â€¢â€¢â€¢â€¢â€¢â€¢â€¢â€¢" maxlength="20"
             onkeydown="if(event.key==='Enter') unlockDiary()">
      <button class="lock-btn" onclick="unlockDiary()">è§£é” ğŸ’•</button>
    </div>
    <div class="lock-error hidden" id="lock-error">å¯†ç ä¸å¯¹å“¦ï¼Œå†æƒ³æƒ³ï½</div>
  </div>

  <div class="diary-section">
    <div class="section-title">æˆ‘ä»¬çš„æ—¥è®°æœ¬ ğŸ“–</div>
    <div class="diary-form">
      <textarea id="diary-text" placeholder="ä»Šå¤©æƒ³è®°å½•ä»€ä¹ˆå‘¢...å†™ä¸‹æˆ‘ä»¬çš„æ•…äº‹å§ â™¡"></textarea>
      <div class="photo-upload-area">
        <input type="file" id="photo-input" accept="image/*" multiple onchange="handlePhotos(this)">
        <div class="photo-upload-text">
          <span class="icon">ğŸ“·</span>
          ç‚¹å‡»ä¸Šä¼ æˆ‘ä»¬çš„ç…§ç‰‡
        </div>
      </div>
      <div class="photo-preview" id="photo-preview"></div>
      <button class="btn-submit-diary" id="btn-submit" onclick="submitDiary()">è®°å½•è¿™ä¸€åˆ» ğŸ’</button>
    </div>
    <div class="diary-entries" id="diary-entries"></div>
    <div class="reset-link" onclick="resetAll()">é‡ç½®é¡µé¢</div>
  </div>
</div>

<!-- ============ Firebase SDK (äº‘ç«¯åŒæ­¥) ============ -->
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/10.12.0/firebase-firestore-compat.js"></script>

<script>
// ============ FIREBASE åˆå§‹åŒ– ============
firebase.initializeApp({
  apiKey: "AIzaSyDeuUiRw2i14ppo6y31NuRakb45O1P_rR8",
  authDomain: "love-yjy-zyc.firebaseapp.com",
  projectId: "love-yjy-zyc",
  storageBucket: "love-yjy-zyc.firebasestorage.app",
  messagingSenderId: "33621692065",
  appId: "1:33621692065:web:328f44f2e55406c408aae0"
});
const db = firebase.firestore();

// ============ CLOUDINARY é…ç½® (ç…§ç‰‡äº‘å­˜å‚¨) ============
const CLOUD_NAME = 'dllpw6ttq';
const UPLOAD_PRESET = 'ybg1fotj';

// ============ PARTICLES ============
(function() {
  const container = document.getElementById('particles');
  const emojis = ['ğŸ’•', 'ğŸŒ¸', 'âœ¨', 'ğŸ’—', 'ğŸ€', 'ğŸ’–', 'ğŸŒ¹', 'â™¡'];
  for (let i = 0; i < 20; i++) {
    const p = document.createElement('div');
    p.className = 'particle';
    p.textContent = emojis[Math.floor(Math.random() * emojis.length)];
    p.style.left = Math.random() * 100 + '%';
    p.style.animationDelay = Math.random() * 8 + 's';
    p.style.animationDuration = (6 + Math.random() * 6) + 's';
    container.appendChild(p);
  }
})();

// ============ STATE (ä»Firebaseè¯»å–ï¼Œæ›¿ä»£localStorage) ============
let appState = { together_since: null, accepted: false };

async function loadState() {
  try {
    const doc = await db.collection('app').doc('state').get();
    if (doc.exists) {
      appState = doc.data();
    }
  } catch(e) {
    console.error('loadState error:', e);
  }
}

async function saveState() {
  try {
    await db.collection('app').doc('state').set(appState);
  } catch(e) {
    console.error('saveState error:', e);
  }
}

const isAccepted = () => appState.accepted;

// ============ DIARY LOCK (å¯†ç é”) ============
let diaryUnlocked = false;
const DIARY_PASSWORD_HASH = '83155287ee2b5b0ef733dff2aa53bbc6d1117788ea02ec01b0d6945f27353e49';

// è®¡ç®—å­—ç¬¦ä¸²çš„ SHA-256 å“ˆå¸Œ
async function sha256(text) {
  const data = new TextEncoder().encode(text);
  const hashBuffer = await crypto.subtle.digest('SHA-256', data);
  return Array.from(new Uint8Array(hashBuffer)).map(b => b.toString(16).padStart(2, '0')).join('');
}

async function unlockDiary() {
  const input = document.getElementById('lock-password');
  const errorEl = document.getElementById('lock-error');
  const overlay = document.getElementById('diary-lock');

  const inputHash = await sha256(input.value);

  if (inputHash === DIARY_PASSWORD_HASH) {
    diaryUnlocked = true;
    overlay.classList.add('unlocked');
    setTimeout(() => { overlay.style.display = 'none'; }, 500);
    errorEl.classList.add('hidden');
  } else {
    errorEl.classList.remove('hidden');
    input.classList.add('shake');
    setTimeout(() => input.classList.remove('shake'), 400);
    input.value = '';
    input.focus();
  }
}

// æ¯æ¬¡åˆ‡æ¢åˆ°æ—¥è®°é¡µæ—¶é‡æ–°æ˜¾ç¤ºé”ï¼ˆå¦‚æœæœªè§£é”ï¼‰
function showDiaryLock() {
  const overlay = document.getElementById('diary-lock');
  if (!diaryUnlocked) {
    overlay.style.display = 'flex';
    overlay.classList.remove('unlocked');
    document.getElementById('lock-password').value = '';
    document.getElementById('lock-error').classList.add('hidden');
  }
}

// ============ PAGE SWITCHING (åº•éƒ¨å¯¼èˆª) ============
function switchPage(name) {
  // éšè—æ‰€æœ‰é¡µé¢
  document.querySelectorAll('.page').forEach(p => {
    p.classList.remove('active');
    p.style.display = 'none';
  });

  // æ˜¾ç¤ºç›®æ ‡é¡µé¢
  const target = document.getElementById('page-' + name);
  target.classList.add('active');
  target.style.display = 'flex';

  // æ›´æ–°å¯¼èˆªé«˜äº®
  document.querySelectorAll('.nav-item').forEach(n => n.classList.remove('active'));
  const navItem = document.getElementById('nav-' + name);
  if (navItem) navItem.classList.add('active');

  // åˆ‡æ¢åˆ°åœ¨ä¸€èµ·é¡µæ—¶å¯åŠ¨è®¡æ—¶å™¨
  if (name === 'together' && isAccepted()) startTimer();
  // åˆ‡æ¢åˆ°æ—¥è®°é¡µæ—¶æ˜¾ç¤ºå¯†ç é”+åŠ è½½æ—¥è®°
  if (name === 'diary') {
    showDiaryLock();
    loadDiary();
  }

  window.scrollTo(0, 0);
}

// ============ FIRST-TIME FLOW: æƒ…ä¹¦ â†’ è¡¨ç™½ ============
function goToQuestion() {
  // å·²ç»è¡¨ç™½è¿‡ï¼šç›´æ¥è·³åˆ°åœ¨ä¸€èµ·é¡µï¼ˆé€šè¿‡å¯¼èˆªï¼‰
  if (isAccepted()) {
    switchPage('together');
    return;
  }
  // ç¬¬ä¸€æ¬¡ï¼šè¿›å…¥è¡¨ç™½é¡µ
  document.getElementById('page-letter').classList.remove('active');
  document.getElementById('page-letter').style.display = 'none';
  const q = document.getElementById('page-question');
  q.classList.add('active');
  q.style.display = 'flex';
}

// ============ RUN AWAY BUTTON (ä¸æ„¿æ„æŒ‰é’®ä¹±è·‘) ============
let noClickCount = 0;
const funnyTexts = [
  'ä¸æ„¿æ„', 'å†æƒ³æƒ³ï¼Ÿ', 'çœŸçš„å—ï¼Ÿ', 'ä¸è®¸é€‰è¿™ä¸ªï¼',
  'äººå®¶ä¼šä¼¤å¿ƒçš„', 'æŠ“ä¸åˆ°æˆ‘ï½', 'å˜¿å˜¿æºœäº†', 'åˆ«ç‚¹æˆ‘å•¦ï¼',
  'ä½ ç¡®å®šï¼Ÿ', 'å†ç»™æ¬¡æœºä¼š', 'é€ƒè·‘ä¸­...', 'å°±è¯´æ„¿æ„å˜›ï¼'
];

function runAway() {
  const btn = document.getElementById('btn-no');
  noClickCount++;
  btn.textContent = funnyTexts[Math.min(noClickCount, funnyTexts.length - 1)];

  const maxX = window.innerWidth - 140;
  const maxY = window.innerHeight - 60;
  btn.style.position = 'fixed';
  btn.style.left = Math.random() * maxX + 'px';
  btn.style.top = Math.random() * maxY + 'px';
  btn.style.zIndex = '10';

  // "Yes" grows bigger
  const yesBtn = document.querySelector('.btn-yes');
  yesBtn.style.transform = `scale(${Math.min(1 + noClickCount * 0.06, 1.6)})`;
}

// ============ SAY YES (ä¿å­˜åˆ°Firebaseäº‘ç«¯) ============
async function sayYes() {
  if (!appState.accepted) {
    appState.accepted = true;
    appState.together_since = new Date().toISOString();
    await saveState(); // ä¿å­˜åˆ°Firebaseï¼Œå¤šç«¯åŒæ­¥
  }
  launchConfetti();
  setTimeout(() => {
    // æ˜¾ç¤ºåº•éƒ¨å¯¼èˆª
    document.getElementById('bottom-nav').classList.add('visible');
    document.body.style.paddingBottom = '70px';
    // éšè—æƒ…ä¹¦é¡µçš„"ç»§ç»­"æŒ‰é’®ï¼ˆä»¥åé€šè¿‡å¯¼èˆªæ åˆ‡æ¢ï¼‰
    document.getElementById('scroll-hint').style.display = 'none';
    // å»æ‰æƒ…ä¹¦çš„é€è¡ŒåŠ¨ç”»ï¼ˆä»¥åå†çœ‹ä¸éœ€è¦ç­‰åŠ¨ç”»ï¼‰
    document.getElementById('letter-body').classList.remove('animate');
    // è·³è½¬åˆ°åœ¨ä¸€èµ·é¡µé¢
    switchPage('together');
  }, 1500);
}

// ============ CONFETTI (æ’’èŠ±) ============
function launchConfetti() {
  const container = document.getElementById('confetti');
  const shapes = ['â¤ï¸', 'ğŸ’•', 'ğŸ‰', 'ğŸŠ', 'âœ¨', 'ğŸ’–', 'ğŸŒ¹'];
  for (let i = 0; i < 60; i++) {
    const piece = document.createElement('div');
    piece.className = 'confetti-piece';
    piece.textContent = shapes[Math.floor(Math.random() * shapes.length)];
    piece.style.left = Math.random() * 100 + '%';
    piece.style.animationDelay = Math.random() * 1.5 + 's';
    piece.style.fontSize = (0.8 + Math.random() * 1.2) + 'rem';
    container.appendChild(piece);
  }
  setTimeout(() => container.innerHTML = '', 4000);
}

// ============ TIMER (è®¡æ—¶å™¨ï¼Œæ—¥æœŸä»Firebaseè¯»å–) ============
let timerStarted = false;
function startTimer() {
  if (timerStarted || !appState.together_since) return;
  timerStarted = true;
  const since = new Date(appState.together_since);
  function update() {
    const diff = Date.now() - since;
    const days = Math.floor(diff / 86400000);
    const hours = Math.floor((diff % 86400000) / 3600000);
    const minutes = Math.floor((diff % 3600000) / 60000);
    const seconds = Math.floor((diff % 60000) / 1000);
    document.getElementById('timer-value').innerHTML = `
      <span>${days}<small class="timer-unit">å¤©</small></span>
      <span>${String(hours).padStart(2,'0')}<small class="timer-unit">æ—¶</small></span>
      <span>${String(minutes).padStart(2,'0')}<small class="timer-unit">åˆ†</small></span>
      <span>${String(seconds).padStart(2,'0')}<small class="timer-unit">ç§’</small></span>`;
    document.getElementById('heart-days').textContent = days + ' å¤©';
  }
  update();
  setInterval(update, 1000);
}

// ============ CLOUDINARY ç…§ç‰‡ä¸Šä¼  ============
async function uploadToCloudinary(file) {
  const formData = new FormData();
  formData.append('file', file);
  formData.append('upload_preset', UPLOAD_PRESET);
  formData.append('folder', 'love-diary');
  const res = await fetch(`https://api.cloudinary.com/v1_1/${CLOUD_NAME}/image/upload`, {
    method: 'POST',
    body: formData
  });
  const data = await res.json();
  return data.secure_url; // è¿”å›ç…§ç‰‡çš„æ°¸ä¹…URL
}

// ============ DIARY (æ—¥è®°æœ¬ï¼šFirebase + Cloudinary) ============
let pendingFiles = [];    // å¾…ä¸Šä¼ çš„Fileå¯¹è±¡
let pendingPreviews = []; // æœ¬åœ°é¢„è§ˆURL

function handlePhotos(input) {
  const preview = document.getElementById('photo-preview');
  preview.innerHTML = '';
  pendingFiles = [];
  pendingPreviews = [];
  Array.from(input.files).forEach(file => {
    pendingFiles.push(file);
    const url = URL.createObjectURL(file);
    pendingPreviews.push(url);
    const img = document.createElement('img');
    img.src = url;
    preview.appendChild(img);
  });
}

async function submitDiary() {
  const text = document.getElementById('diary-text').value.trim();
  if (!text && pendingFiles.length === 0) return;

  // ç¦ç”¨æŒ‰é’®ï¼Œæ˜¾ç¤ºä¸Šä¼ ä¸­
  const btn = document.getElementById('btn-submit');
  btn.disabled = true;
  btn.textContent = 'ä¸Šä¼ ä¸­...';

  try {
    // 1. ä¸Šä¼ ç…§ç‰‡åˆ°Cloudinary
    const photoUrls = [];
    for (const file of pendingFiles) {
      const url = await uploadToCloudinary(file);
      photoUrls.push(url);
    }

    // 2. ä¿å­˜æ—¥è®°åˆ°Firestore
    await db.collection('diary').add({
      text: text,
      photos: photoUrls,
      date: new Date().toLocaleString('zh-CN'),
      timestamp: firebase.firestore.FieldValue.serverTimestamp()
    });

    // 3. æ¸…ç©ºè¡¨å•
    document.getElementById('diary-text').value = '';
    document.getElementById('photo-preview').innerHTML = '';
    document.getElementById('photo-input').value = '';
    pendingFiles = [];
    pendingPreviews = [];

    // 4. é‡æ–°åŠ è½½æ—¥è®°åˆ—è¡¨
    loadDiary();
  } catch(e) {
    console.error('submitDiary error:', e);
    alert('ä¿å­˜å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œåé‡è¯•');
  }

  btn.disabled = false;
  btn.textContent = 'è®°å½•è¿™ä¸€åˆ» ğŸ’';
}

async function loadDiary() {
  try {
    const snapshot = await db.collection('diary').orderBy('timestamp', 'desc').get();
    const container = document.getElementById('diary-entries');
    container.innerHTML = '';
    snapshot.forEach((doc, i) => {
      const entry = doc.data();
      const div = document.createElement('div');
      div.className = 'diary-entry';
      div.style.animationDelay = (i * 0.1) + 's';
      let photosHTML = '';
      if (entry.photos && entry.photos.length > 0) {
        photosHTML = '<div class="entry-photos">' +
          entry.photos.map(p => `<img src="${p}" onclick="openLightbox(this.src)">`).join('') +
          '</div>';
      }
      div.innerHTML = `
        <button class="entry-delete" onclick="deleteEntry('${doc.id}')">Ã—</button>
        <div class="entry-date">${entry.date || ''}</div>
        ${entry.text ? `<div class="entry-text">${escapeHtml(entry.text)}</div>` : ''}
        ${photosHTML}`;
      container.appendChild(div);
    });
  } catch(e) {
    console.error('loadDiary error:', e);
  }
}

async function deleteEntry(id) {
  if (!confirm('ç¡®å®šåˆ é™¤è¿™æ¡æ—¥è®°å—ï¼Ÿ')) return;
  try {
    await db.collection('diary').doc(id).delete();
    loadDiary();
  } catch(e) {
    console.error('deleteEntry error:', e);
  }
}

function escapeHtml(str) {
  const d = document.createElement('div');
  d.textContent = str;
  return d.innerHTML;
}

function openLightbox(src) {
  document.getElementById('lightbox-img').src = src;
  document.getElementById('lightbox').classList.add('active');
}

// ============ é‡ç½®ï¼ˆæ¸…é™¤äº‘ç«¯æ‰€æœ‰æ•°æ®ï¼‰ ============
async function resetAll() {
  if (!confirm('ç¡®å®šé‡ç½®å—ï¼Ÿè¿™ä¼šæ¸…é™¤äº‘ç«¯æ‰€æœ‰æ•°æ®ï¼ˆæ—¥è®°ã€è®¡æ—¶ã€è¡¨ç™½çŠ¶æ€ï¼‰å¹¶å›åˆ°æœ€åˆçš„æƒ…ä¹¦é¡µé¢ã€‚')) return;
  try {
    // åˆ é™¤è¡¨ç™½çŠ¶æ€
    await db.collection('app').doc('state').delete();
    // åˆ é™¤æ‰€æœ‰æ—¥è®°æ¡ç›®
    const snapshot = await db.collection('diary').get();
    const batch = db.batch();
    snapshot.forEach(doc => batch.delete(doc.ref));
    await batch.commit();
  } catch(e) {
    console.error('resetAll error:', e);
  }
  location.reload();
}

// ============ é¡µé¢åˆå§‹åŒ–ï¼ˆä»FirebaseåŠ è½½çŠ¶æ€ï¼‰ ============
window.addEventListener('DOMContentLoaded', async () => {
  // ä»Firebaseè¯»å–è¡¨ç™½çŠ¶æ€å’Œåœ¨ä¸€èµ·æ—¥æœŸ
  await loadState();

  // éšè—åŠ è½½é®ç½©
  document.getElementById('loading-overlay').classList.add('hidden');

  if (isAccepted()) {
    // å·²ç»è¡¨ç™½è¿‡ï¼šæ˜¾ç¤ºåº•éƒ¨å¯¼èˆªï¼Œéšè—"ç»§ç»­"æŒ‰é’®ï¼Œå»æ‰é€è¡ŒåŠ¨ç”»
    document.getElementById('bottom-nav').classList.add('visible');
    document.body.style.paddingBottom = '70px';
    document.getElementById('scroll-hint').style.display = 'none';
    document.getElementById('letter-body').classList.remove('animate');
    // é»˜è®¤æ˜¾ç¤ºåœ¨ä¸€èµ·é¡µé¢
    switchPage('together');
  }
  // æœªè¡¨ç™½ï¼šé»˜è®¤æ˜¾ç¤ºæƒ…ä¹¦é¡µ + "ç»§ç»­"æŒ‰é’®ï¼Œæ— åº•éƒ¨å¯¼èˆª
});
</script>
</body>
</html>
